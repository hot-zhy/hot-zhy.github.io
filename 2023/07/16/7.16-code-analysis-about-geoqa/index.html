

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/xiaoxin.png">
  <link rel="icon" href="/img/xiaoxin.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ECNU_zhy">
  <meta name="keywords" content="智慧教育,GeoQA,自动几何数学求解器">
  
    <meta name="description" content="GeoQA代码分析  ——以具体题目为例 原题目：1234567&amp;#123;&quot;id&quot;: 0,  &quot;subject&quot;: &quot;如图,在△ABC中,已知∠A&#x3D;80°,∠B&#x3D;60°,DE∥BC,那么∠CED的大小是()&quot;,  &quot;choices&quot;: [&quot;40°&quot;, &quot;60°&quot;, &quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="GeoQA代码分析以及论文解读-以题目为例">
<meta property="og:url" content="http://example.com/2023/07/16/7.16-code-analysis-about-geoqa/index.html">
<meta property="og:site_name" content="zhy-blog">
<meta property="og:description" content="GeoQA代码分析  ——以具体题目为例 原题目：1234567&amp;#123;&quot;id&quot;: 0,  &quot;subject&quot;: &quot;如图,在△ABC中,已知∠A&#x3D;80°,∠B&#x3D;60°,DE∥BC,那么∠CED的大小是()&quot;,  &quot;choices&quot;: [&quot;40°&quot;, &quot;60°&quot;, &quot;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716163910084.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230715095937359.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716142814332.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716142804284.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716201329867.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716205930890.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716210944396.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716142750087.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716142840615.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716213334664.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716213354244.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716214209397.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716231903333.png">
<meta property="og:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716232132074.png">
<meta property="article:published_time" content="2023-07-16T15:43:44.000Z">
<meta property="article:modified_time" content="2023-07-16T15:28:22.107Z">
<meta property="article:author" content="ECNU_zhy">
<meta property="article:tag" content="智慧教育">
<meta property="article:tag" content="自动数学求解器">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/7.16-code-analysis-about-geoqa/image-20230716163910084.png">
  
  
  
  <title>GeoQA代码分析以及论文解读-以题目为例 - zhy-blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ECNU-zhy</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="GeoQA代码分析以及论文解读-以题目为例"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-16 23:43" pubdate>
          July 16, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          213 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">GeoQA代码分析以及论文解读-以题目为例</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="GeoQA代码分析"><a href="#GeoQA代码分析" class="headerlink" title="GeoQA代码分析"></a>GeoQA代码分析</h1><img src="/images/7.16-code-analysis-about-geoqa/image-20230716163910084.png" srcset="/img/loading.gif" lazyload alt="image-20230716163910084" style="zoom:80%;" />

<p>——以具体题目为例</p>
<h4 id="原题目："><a href="#原题目：" class="headerlink" title="原题目："></a>原题目：</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br> <span class="hljs-attr">&quot;subject&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;如图,在△ABC中,已知∠A=80°,∠B=60°,DE∥BC,那么∠CED的大小是()&quot;</span><span class="hljs-punctuation">,</span> <br> <span class="hljs-attr">&quot;choices&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;40°&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;60°&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;120°&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;140°&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;label&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <br> <span class="hljs-attr">&quot;formal_point&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;对顶角&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;三角形内角和&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;邻补角&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;answer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;∵∠A+∠B+∠C=180°(三角形内角和定理),∠A=80°,∠B=60°,∴∠C=180°-∠A-∠B=180°-80°-60°=40°,又∵DE//BC,∴∠CED+∠C=180°(两直线平行,同旁内角互补).∴∠CED=180°-40°=140°.故选D.&quot;</span><span class="hljs-punctuation">,</span> <br> <span class="hljs-attr">&quot;comment&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="/images/7.16-code-analysis-about-geoqa/image-20230715095937359.png" srcset="/img/loading.gif" lazyload alt="image-20230715095937359"></p>
<h4 id="代码从数据集中读取的原始数据-pickle"><a href="#代码从数据集中读取的原始数据-pickle" class="headerlink" title="代码从数据集中读取的原始数据(pickle)"></a>代码从数据集中读取的原始数据(pickle)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    &#x27;token_list&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&#x27;如&#x27;<span class="hljs-punctuation">,</span> &#x27;图&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">,</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;在&#x27;<span class="hljs-punctuation">,</span> &#x27;△&#x27;<span class="hljs-punctuation">,</span> &#x27;A&#x27;<span class="hljs-punctuation">,</span> &#x27;B&#x27;<span class="hljs-punctuation">,</span> &#x27;C&#x27;<span class="hljs-punctuation">,</span> &#x27;中&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">,</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;已&#x27;<span class="hljs-punctuation">,</span> &#x27;知&#x27;<span class="hljs-punctuation">,</span> &#x27;∠&#x27;<span class="hljs-punctuation">,</span> &#x27;A&#x27;<span class="hljs-punctuation">,</span> &#x27;=&#x27;<span class="hljs-punctuation">,</span> &#x27;N_0&#x27;<span class="hljs-punctuation">,</span> &#x27;°&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">,</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;∠&#x27;<span class="hljs-punctuation">,</span> &#x27;B&#x27;<span class="hljs-punctuation">,</span> &#x27;=&#x27;<span class="hljs-punctuation">,</span> &#x27;N_1&#x27;<span class="hljs-punctuation">,</span> &#x27;°&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">,</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;D&#x27;<span class="hljs-punctuation">,</span> &#x27;E&#x27;<span class="hljs-punctuation">,</span> &#x27;∥&#x27;<span class="hljs-punctuation">,</span> &#x27;B&#x27;<span class="hljs-punctuation">,</span> &#x27;C&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">,</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;那&#x27;<span class="hljs-punctuation">,</span> &#x27;么&#x27;<span class="hljs-punctuation">,</span> &#x27;∠&#x27;<span class="hljs-punctuation">,</span> &#x27;C&#x27;<span class="hljs-punctuation">,</span> &#x27;E&#x27;<span class="hljs-punctuation">,</span> &#x27;D&#x27;<span class="hljs-punctuation">,</span> &#x27;的&#x27;<span class="hljs-punctuation">,</span> &#x27;大&#x27;<span class="hljs-punctuation">,</span> &#x27;小&#x27;<span class="hljs-punctuation">,</span> &#x27;是&#x27;<span class="hljs-punctuation">,</span> &#x27;(&#x27;<span class="hljs-punctuation">,</span> &#x27;)&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>    &#x27;subject&#x27;<span class="hljs-punctuation">:</span> &#x27;如图<span class="hljs-punctuation">,</span>在△ABC中<span class="hljs-punctuation">,</span>已知∠A=<span class="hljs-number">80</span>°<span class="hljs-punctuation">,</span>∠B=<span class="hljs-number">60</span>°<span class="hljs-punctuation">,</span>DE∥BC<span class="hljs-punctuation">,</span>那么∠CED的大小是()&#x27;<span class="hljs-punctuation">,</span> <br>    &#x27;choices&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&#x27;<span class="hljs-number">40</span>°&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-number">60</span>°&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-number">120</span>°&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-number">140</span>°&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>    &#x27;numbers&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">80.0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">60.0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>    &#x27;choice_nums&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">40.0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">60.0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">120.0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">140.0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    &#x27;image&#x27;<span class="hljs-punctuation">:</span> array(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-punctuation">[</span><span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-punctuation">[</span><span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       ...<span class="hljs-punctuation">,</span><br>       <span class="hljs-punctuation">[</span><span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">160</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span> <span class="hljs-number">227</span><span class="hljs-punctuation">,</span> <span class="hljs-number">182</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-punctuation">[</span><span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">89</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">72</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-punctuation">[</span><span class="hljs-number">193</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">,</span> <span class="hljs-number">255</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> dtype=uint8)<span class="hljs-punctuation">,</span> <br>    &#x27;label&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <br>    &#x27;answer&#x27;<span class="hljs-punctuation">:</span> &#x27;∵∠A+∠B+∠C=<span class="hljs-number">180</span>°(三角形内角和定理)<span class="hljs-punctuation">,</span>∠A=<span class="hljs-number">80</span>°<span class="hljs-punctuation">,</span>∠B=<span class="hljs-number">60</span>°<span class="hljs-punctuation">,</span>∴∠C=<span class="hljs-number">180</span>°-∠A-∠B=<span class="hljs-number">180</span>°<span class="hljs-number">-80</span>°<span class="hljs-number">-60</span>°=<span class="hljs-number">40</span>°<span class="hljs-punctuation">,</span>又∵DE<span class="hljs-comment">//BC,∴∠CED+∠C=180°(两直线平行,同旁内角互补).∴∠CED=180°-40°=140°.故选D.&#x27;,</span><br>    &#x27;formal_point&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>&#x27;邻补角&#x27;<span class="hljs-punctuation">,</span> &#x27;三角形内角和&#x27;<span class="hljs-punctuation">,</span> &#x27;对顶角&#x27;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    &#x27;target_number&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">140.0</span><span class="hljs-punctuation">,</span><br>    &#x27;id&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br>    &#x27;manual_program&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;C_3&#x27;<span class="hljs-punctuation">,</span> &#x27;N_0&#x27;<span class="hljs-punctuation">,</span> &#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;V_0&#x27;<span class="hljs-punctuation">,</span> &#x27;N_1&#x27;<span class="hljs-punctuation">,</span> &#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;C_3&#x27;<span class="hljs-punctuation">,</span> &#x27;V_1&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="文本处理过程"><a href="#文本处理过程" class="headerlink" title="文本处理过程"></a>文本处理过程</h2><p><img src="/images/7.16-code-analysis-about-geoqa/image-20230716142814332.png" srcset="/img/loading.gif" lazyload alt="image-20230716142814332"></p>
<p>在forward函数中调用_encode函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">state = self._encode(source_tokens)<br></code></pre></td></tr></table></figure>

<h3 id="encode的过程如下，即-encode的执行流程"><a href="#encode的过程如下，即-encode的执行流程" class="headerlink" title="encode的过程如下，即_encode的执行流程"></a>encode的过程如下，即_encode的执行流程</h3><h4 id="将source-tokens中的string通过Vocabulary类映射到整数编码上"><a href="#将source-tokens中的string通过Vocabulary类映射到整数编码上" class="headerlink" title="将source_tokens中的string通过Vocabulary类映射到整数编码上:"></a>将source_tokens中的string通过Vocabulary类映射到整数编码上:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">vocab: Vocabulary<br><span class="hljs-built_in">super</span>(SimpleSeq2Seq, self).__init__(vocab)<br>//Vocabulary类可以实现从index到token以及token到index的转换<br>self._token_to_index = _TokenToIndexDefaultDict(self._non_padded_namespaces,<br>                                                        self._padding_token,<br>                                                        self._oov_token)<br>self._index_to_token = _IndexToTokenDefaultDict(self._non_padded_namespaces,<br>                                                self._padding_token,<br>                                                self._oov_token)<br></code></pre></td></tr></table></figure>

<h4 id="映射后的整数编码："><a href="#映射后的整数编码：" class="headerlink" title="映射后的整数编码："></a>映射后的整数编码：</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;tokens&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">66</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-number">123</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">183</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">86</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">65</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">54</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span> <span class="hljs-number">183</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">23</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">86</span><span class="hljs-punctuation">,</span> <span class="hljs-number">183</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">9</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">36</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">47</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">26</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">17</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">72</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">71</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">35</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">26</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">16</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">9</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">82</span><span class="hljs-punctuation">,</span> <span class="hljs-number">137</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">41</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">51</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">108</span><span class="hljs-punctuation">,</span> <span class="hljs-number">109</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">17</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">22</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">16</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">9</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">41</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">51</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">21</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">34</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">16</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">40</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">75</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">44</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">16</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">23</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">68</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">31</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">17</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">72</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">71</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">42</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">37</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">66</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">55</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">31</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">46</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">66</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span> <span class="hljs-number">102</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-number">102</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">11</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">193</span><span class="hljs-punctuation">,</span> <span class="hljs-number">133</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">42</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span> <span class="hljs-number">133</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">27</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">23</span><span class="hljs-punctuation">,</span> <span class="hljs-number">193</span><span class="hljs-punctuation">,</span> <span class="hljs-number">133</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">42</span><span class="hljs-punctuation">,</span>   <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">24</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">46</span><span class="hljs-punctuation">,</span> <span class="hljs-number">133</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">17</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="Dense-embedding-of-source-vocab-tokens-对源语言词汇表中的每个词汇（token）进行密集嵌入（dense-embedding）"><a href="#Dense-embedding-of-source-vocab-tokens-对源语言词汇表中的每个词汇（token）进行密集嵌入（dense-embedding）" class="headerlink" title="Dense embedding of source vocab tokens(对源语言词汇表中的每个词汇（token）进行密集嵌入（dense embedding）)"></a><strong>Dense embedding of source vocab tokens(对源语言词汇表中的每个词汇（token）进行密集嵌入（dense embedding）)</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">embedded_input = self._source_embedder(source_tokens)<br></code></pre></td></tr></table></figure>

<p>将源语言的文本数据转换为<strong>连续、密集的实数向量</strong>，从而方便模型学习文本数据的表示和语义信息，从而提高模型在自然语言处理任务中的性能。</p>
<h4 id="经过密集嵌入后的文本表示"><a href="#经过密集嵌入后的文本表示" class="headerlink" title="经过密集嵌入后的文本表示"></a>经过密集嵌入后的文本表示</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">0.0531</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0503</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0213</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0139</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0104</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0440</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0464</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0214</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0172</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0282</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0524</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0017</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0620</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0129</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0032</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0518</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0445</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0315</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0283</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0190</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0054</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0058</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0033</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0592</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0108</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0488</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0222</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0404</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0484</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0522</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0197</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0025</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0153</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0335</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0397</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0521</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">0.0531</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0503</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0213</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0139</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0104</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0440</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0464</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0214</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0172</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0282</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0524</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0017</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0620</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0129</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0032</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0518</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0445</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0315</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0134</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0460</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0388</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0557</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0514</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0283</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0190</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0054</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0058</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0033</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0592</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0108</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0488</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0222</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0404</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0484</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0522</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0065</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0099</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0264</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0481</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0185</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0319</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0316</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0120</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0048</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0444</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0203</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0102</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0606</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0007</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0137</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0086</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0351</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0533</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0183</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0066</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0517</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0461</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0141</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0274</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;CatBackward0&gt;)<br></code></pre></td></tr></table></figure>

<h5 id="为什么要进行嵌入操作？"><a href="#为什么要进行嵌入操作？" class="headerlink" title="为什么要进行嵌入操作？"></a>为什么要进行嵌入操作？</h5><p>将输入的整数索引转换为词嵌入向量的过程是将<strong>离散的单词</strong>表示（整数索引）映射到<strong>连续的向量空间</strong>的过程，泽众映射叫做 **词嵌入(Word Embedding)**。</p>
<p>将单词表示为<strong>连续的向量表示</strong>，有助于捕捉单词之间的语义关系和相似性，在连续向量空间中，具有相似语义的单词在空间中更接近，从而有助于提高模型在语义理解任务中的表现，更好地捕捉单词之间的语义关系和上下文信息。</p>
<p>例如，当<code>source_tokens</code>包含以下内容时:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">source_tokens = &#123;<br>    <span class="hljs-string">&#x27;tokens&#x27;</span>: torch.tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>]])<br>&#125;<br></code></pre></td></tr></table></figure>

<p>假设这里有一个简单的词汇表，其中包含7个单词：[‘<pad>‘, ‘I’, ‘love’, ‘to’, ‘eat’, ‘pizza’, ‘and’]，并且这些单词在词汇表中的索引为：</p>
<p>在这个例子中，<code>source_tokens</code> 是一个字典，其中 <code>&#39;tokens&#39;</code> 键对应的值是一个形状为 (2, 4) 的张量（二维数组），表示两个输入样本，每个样本有4个单词。</p>
<p>当执行 <code>embedded_input = self._source_embedder(source_tokens)</code> 时，<code>self._source_embedder</code> 将会把 <code>source_tokens</code> 中的整数索引转换为对应的词嵌入向量，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">词嵌入表：<br>[<br>    [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>],  <span class="hljs-comment"># 表示 &#x27;&lt;pad&gt;&#x27;</span><br>    [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.3</span>],  <span class="hljs-comment"># 表示 &#x27;I&#x27;</span><br>    [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>],  <span class="hljs-comment"># 表示 &#x27;love&#x27;</span><br>    [<span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>],  <span class="hljs-comment"># 表示 &#x27;to&#x27;</span><br>    [<span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>],  <span class="hljs-comment"># 表示 &#x27;eat&#x27;</span><br>    [<span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>],  <span class="hljs-comment"># 表示 &#x27;pizza&#x27;</span><br>    [<span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>],  <span class="hljs-comment"># 表示 &#x27;and&#x27;</span><br>]<br></code></pre></td></tr></table></figure>

<p>那么 <code>embedded_input</code> 将会得到一个形状为 (2, 4, embedding_dim) 的张量，其中 <code>embedding_dim</code> 是词嵌入的维度。例如，假设 <code>embedding_dim</code> 是 7，则结果可能为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">embedded_input = torch.tensor([<br>    [<br>        [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.3</span>],  <span class="hljs-comment"># &#x27;I&#x27;</span><br>        [<span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>],  <span class="hljs-comment"># &#x27;to&#x27;</span><br>        [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>],  <span class="hljs-comment"># &#x27;love&#x27;</span><br>        [<span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>],  <span class="hljs-comment"># &#x27;pizza&#x27;</span><br>    ],<br>    [<br>        [<span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>],  <span class="hljs-comment"># &#x27;eat&#x27;</span><br>        [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>],  <span class="hljs-comment"># &#x27;love&#x27;</span><br>        [<span class="hljs-number">0.6</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>],  <span class="hljs-comment"># &#x27;and&#x27;</span><br>        [<span class="hljs-number">0.9</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.3</span>],  <span class="hljs-comment"># &#x27;I&#x27;</span><br>    ]<br>])<br></code></pre></td></tr></table></figure>

<p>这样，我们就得到了将 <code>source_tokens</code> 中的整数索引转换为词嵌入向量后的表示 <code>embedded_input</code>。这些词嵌入向量将被用于后续的深度学习模型处理。词嵌入向量中的每个值并不是随机的，而是通过模型训练过程学习得到的，以表达单词之间的语义关系。</p>
<h4 id="获取文本掩码"><a href="#获取文本掩码" class="headerlink" title="获取文本掩码"></a>获取文本掩码</h4><h5 id="为什么要用掩码？"><a href="#为什么要用掩码？" class="headerlink" title="为什么要用掩码？"></a>为什么要用掩码？</h5><p>输入的文本序列的<strong>长度可能不一致</strong>，但在深度学习模型中，通常需要将输入序列统一成<strong>相同长度</strong>的张量进行计算。</p>
<p>掩码是一个与输入序列长度相同的张量，其中元素的值为0或1。它的作用是指示哪些位置是真实的单词（非填充部分），哪些位置是填充部分。这样的话，可以将填充部分的计算过程忽略，从而<strong>避免填充部分对模型的计算结果产生影响</strong>。</p>
<ul>
<li>对于真实的单词位置，掩码的值为1，表示这些位置包含<strong>有效</strong>的单词。</li>
<li>对于填充的部分，掩码的值为0，表示这些位置是由于为了统一序列长度而添加的<strong>填充（padding）</strong>单词。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">source_mask = util.get_text_field_mask(source_tokens)<br></code></pre></td></tr></table></figure>

<h5 id="进行掩码处理后的数据"><a href="#进行掩码处理后的数据" class="headerlink" title="进行掩码处理后的数据:"></a>进行掩码处理后的数据:</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<br></code></pre></td></tr></table></figure>

<p>对应位置为<strong>1表示该位置是真实的文本数据</strong>，为<strong>0表示该位置是填充数据</strong>，这样在处理文本数据时，就可以根据掩码忽略填充部分，只关注真实的文本内容</p>
<h4 id="获取图像掩码"><a href="#获取图像掩码" class="headerlink" title="获取图像掩码"></a>获取图像掩码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># source mask are used in attention</span><br>img_mask = torch.ones(source_mask.shape[<span class="hljs-number">0</span>], <span class="hljs-number">196</span>).long().cuda()<br></code></pre></td></tr></table></figure>

<h4 id="将图像掩码（img-mask）和文本掩码（source-mask）拼接在一起"><a href="#将图像掩码（img-mask）和文本掩码（source-mask）拼接在一起" class="headerlink" title="将图像掩码（img_mask）和文本掩码（source_mask）拼接在一起"></a>将图像掩码（img_mask）和文本掩码（source_mask）拼接在一起</h4><p>将图像特征和文本特征合并成一个综合的特征表示，以便在后续的任务中同时使用图像和文本的信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">concat_mask = torch.cat([img_mask, source_mask], <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>将图像掩码（img_mask）和文本掩码（source_mask）拼接在一起，形成<code>concat_mask</code>，用于在后续计算中，将文本和图像的掩码信息合并使用。</p>
<h4 id="文本encode的输出-使用Seq2SeqEncoder"><a href="#文本encode的输出-使用Seq2SeqEncoder" class="headerlink" title="文本encode的输出,使用Seq2SeqEncoder"></a>文本encode的输出,使用Seq2SeqEncoder</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">encoder_outputs = self._encoder(embedded_input, source_mask)<span class="hljs-comment">#保存在state中，用&#x27;encoder_outputs&#x27;获取</span><br>encoder: Seq2SeqEncoder<br><span class="hljs-comment">#在_encode中，return &#123;</span><br><span class="hljs-comment">#                &quot;source_mask&quot;: source_mask,  # source_mask,</span><br><span class="hljs-comment">#                &quot;concat_mask&quot;: concat_mask,</span><br><span class="hljs-comment">#                &quot;encoder_outputs&quot;: encoder_outputs,</span><br><span class="hljs-comment">#        &#125;</span><br></code></pre></td></tr></table></figure>

<p>将<strong>嵌入</strong>的文本数据（<code>embedded_input</code>）和文本掩码（<code>source_mask</code>）输入到编码器（<code>_encoder</code>）中，得到编码器的输出（<code>encoder_outputs</code>）。这个编码过程可以将输入文本数据转换为语义表示，从而用于后续的解码或其他任务</p>
<p>最终文本的输出数据，在forward函数中获取:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">state = self._encode(source_tokens)<br></code></pre></td></tr></table></figure>

<p>得到的<strong>文本输出state</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;source_mask&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> <br> &#x27;concat_mask&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> <br> &#x27;encoder_outputs&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0089</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0061</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0059</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0002</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0017</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0048</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0104</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0165</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0078</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0052</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0026</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0162</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0109</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0157</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0085</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0092</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0002</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0139</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0075</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0042</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0060</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0055</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0035</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0004</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0141</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0138</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0016</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0050</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0010</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0024</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0121</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0118</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0085</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0070</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0019</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0038</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0089</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0061</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0059</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0002</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0017</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0048</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0104</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0165</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0078</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0052</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0026</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0162</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0109</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0157</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0085</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0092</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0002</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0139</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.0075</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0042</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0060</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0055</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0035</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0004</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0141</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0138</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0016</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0050</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0010</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0024</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0099</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0110</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0027</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0100</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0064</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0016</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0178</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0141</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0154</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0040</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0051</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0043</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0231</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0208</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0131</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0075</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0009</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0024</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0194</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0184</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0106</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0064</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0016</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0040</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;IndexSelectBackward0&gt;)<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>文本encode的部分结束，在forward函数中，使用<code>state = self._encode(source_tokens)</code>获取编码的文本信息，再继续进行图像编码，再继续进行fuse和计算。</p>
<h2 id="图像encode的过程"><a href="#图像encode的过程" class="headerlink" title="图像encode的过程"></a>图像encode的过程</h2><p><img src="/images/7.16-code-analysis-about-geoqa/image-20230716142804284.png" srcset="/img/loading.gif" lazyload alt="image-20230716142804284"></p>
<h4 id="首先，新建一个resnet模型"><a href="#首先，新建一个resnet模型" class="headerlink" title="首先，新建一个resnet模型"></a>首先，新建一个resnet模型</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建一个预训练的ResNet-101模型</span><br>resnet = build_model()<br>self.resnet = resnet<br></code></pre></td></tr></table></figure>

<p>在build_model()中:</p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716201329867.png" srcset="/img/loading.gif" lazyload />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_model</span>():<br>    <span class="hljs-comment"># 获取预训练的ResNet-101模型 pretrained=True表示会加载带有预训练权重的模型</span><br>    cnn = <span class="hljs-built_in">getattr</span>(torchvision.models, <span class="hljs-string">&#x27;resnet101&#x27;</span>)(pretrained=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 卷积层 (conv1)、批归一化层 (bn1)、ReLU 激活函数 (relu) 和最大池化层 (maxpool)。</span><br>    layers = [cnn.conv1,<br>              cnn.bn1,<br>              cnn.relu,<br>              cnn.maxpool]<br>    <span class="hljs-comment"># 将ResNet-101模型的其余三个层添加到layers列表中，对应ResNet架构中的不同块</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        name = <span class="hljs-string">&#x27;layer%d&#x27;</span> % (i + <span class="hljs-number">1</span>)<br>        layers.append(<span class="hljs-built_in">getattr</span>(cnn, name))<br>    <span class="hljs-comment"># 创建一个Sequential模型，允许按顺序以此应用这些层到输入数据中</span><br>    model = torch.nn.Sequential(*layers)<br>    <span class="hljs-comment"># 将模型迁移至GPU加速计算</span><br>    model.cuda()<br>    <span class="hljs-comment"># 将模型设置为评估模式</span><br>    model.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-comment"># 返回构建好的模型</span><br>    <span class="hljs-keyword">return</span> model<br></code></pre></td></tr></table></figure>

<h5 id="ResNet-101模型"><a href="#ResNet-101模型" class="headerlink" title="ResNet-101模型"></a>ResNet-101模型</h5><p><code>[论文]Deep Residual Learning for Image Recognition</code></p>
<p>​		ResNet-101使用了残差学习(Residual Learning)的思想来解决深度神经网络中的<strong>梯度消失和梯度爆炸</strong>的问题。残差学习引入残差块(Residual Block)，使得网络可以学习残差映射，即输入特征和输出特征之间的差异，从而减轻梯度消失问题，使得更<strong>深的网络</strong>可以更容易地训练和优化。</p>
<p>​		在传统的深度神经网络中，增加网络的深度会导致训练变得困难，因为深层网络中的梯度会逐渐变小，导致梯度消失问题，使得网络难以收敛。为了解决这个问题，ResNet提出了残差块（Residual Block）的结构。残差块包含了跨越网络层的捷径连接，即输入特征与输出特征之间的差异（残差）。通过学习残差映射，网络可以更容易地优化残差部分，从而使得更深的网络可以被训练得更好。</p>
<h4 id="其次进行图像的预处理"><a href="#其次进行图像的预处理" class="headerlink" title="其次进行图像的预处理"></a>其次进行图像的预处理</h4><p>在forward函数中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 图像通过self.resnet(image)传入resnet模型进行处理</span><br><span class="hljs-comment"># 在该过程中不会影响网络参数，仅进行前向传播的推理过程</span><br><span class="hljs-comment"># 将图像数据输入到ResNet中，经过多个卷积层和池化层，最终得到图像的高级表示，这些特征可以用来图像分类和对象检测</span><br><span class="hljs-keyword">with</span> torch.no_grad():<span class="hljs-comment">#节省内存</span><br>    img_feats = self.resnet(image)<br></code></pre></td></tr></table></figure>

<p>得到的图像预处理的结果:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2.6794e-02</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">4.6280e-02</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">[</span><span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3.6035e-02</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1.4264e-01</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">3.7063e-02</span><span class="hljs-punctuation">,</span> <span class="hljs-number">4.5198e-02</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">[</span><span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5.3535e-02</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">7.6153e-03</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          ...<span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<h4 id="然后，将图像的形状转换为-N-196-C-的形状-N-C-14-14-gt-N-196-C"><a href="#然后，将图像的形状转换为-N-196-C-的形状-N-C-14-14-gt-N-196-C" class="headerlink" title="然后，将图像的形状转换为:(N, 196, C)的形状(N, C, 14, 14) -&gt; (N, 196, C)"></a>然后，将图像的形状转换为:<strong>(N, 196, C)<strong>的形状</strong>(N, C, 14, 14) -&gt; (N, 196, C)</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">img_feats = img_feats.reshape(img_feats.shape[<span class="hljs-number">0</span>], img_feats.shape[<span class="hljs-number">1</span>], -<span class="hljs-number">1</span>).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<ol>
<li><code>img_feats</code>是一个张量，假设它的形状为 <code>(N, C, H, W)</code>，其中：<code>N</code> 表示批次大小（batch size）,<code>N</code> 表示通道数（channels）,<code>H</code> 表示图像高度（height）,<code>W</code> 表示图像宽度（width）</li>
<li><code>img_feats.reshape(img_feats.shape[0], img_feats.shape[1], -1)</code>：<ul>
<li>使用 <code>reshape</code> 函数对 <code>img_feats</code> 进行形状变换，将其调整为 <code>(N, C, H*W)</code> 的形状。这里的 <code>-1</code> 表示该维度的大小将根据其他维度的大小自动计算，确保张量元素的总数量不变。</li>
</ul>
</li>
<li><code>.transpose(1, 2)</code>：<ul>
<li>这一行代码使用 <code>transpose</code> 函数对张量进行转置操作。在这里，维度 1 和维度 2 进行了交换。在原始形状中，维度 1 对应通道数 <code>C</code>，而维度 2 对应图像的高度和宽度的组合 <code>H*W</code>。转置操作后，<code>img_feats</code> 的形状变为 <code>(N, H*W, C)</code>。</li>
</ul>
</li>
</ol>
<p><strong>这样做可以更好地整合和处理图像特征，使得模型在图像处理任务中能够更有效地学习和表达图像的信息。</strong></p>
<p>得到的结果:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.1723</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.1291</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5126</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">0.0268</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.1500</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2367</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4088</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0000</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.1340</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.1610</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7858</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<p>调用channel_transform:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">img_feats = self.channel_transform(img_feats)<br><span class="hljs-comment">## 创建一个线性层，输入特征的维度为 1024，输出特征的维度为 512，对特征进行减少，并希望这种变换能够更好地捕捉图像中与任务相关的信息</span><br><span class="hljs-comment">## 线性变换，全连接层</span><br><span class="hljs-comment">## self.channel_transform = torch.nn.Linear(1024, 512)</span><br></code></pre></td></tr></table></figure>

<p>得到的结果:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">0.2362</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0080</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0822</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1908</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0636</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.1090</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1500</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.1148</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1365</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.2499</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0272</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0957</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.2534</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0941</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.2060</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.3264</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0095</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.1565</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<h5 id="使用共同注意力机制得到融合后的图像信息"><a href="#使用共同注意力机制得到融合后的图像信息" class="headerlink" title="使用共同注意力机制得到融合后的图像信息:"></a>使用共同注意力机制得到融合后的图像信息:</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">_, img_feats = self.mcan(lang_feats, img_feats, lang_mask, img_mask)<br><span class="hljs-comment"># 其中四个参数分别表示state[&#x27;encoder_outputs&#x27;]、self.channel_transform(img_feats)、 make_mask(source_tokens[&#x27;tokens&#x27;].unsqueeze(2))、img_mask = make_mask(img_feats)，即文本特征、图像特征、文本掩码和图像掩码</span><br><br><span class="hljs-comment">## 其中c</span><br><span class="hljs-comment">## 其中MCA_ED表示论文中Joint Reasoning Module的部分</span><br></code></pre></td></tr></table></figure>

<img src="/images/7.16-code-analysis-about-geoqa/image-20230716205930890.png" srcset="/img/loading.gif" lazyload alt="image-20230716205930890" style="zoom:80%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## self.mcan = MCA_ED(__C)的具体实现</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MCA_ED</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, __C</span>):<br>        <span class="hljs-built_in">super</span>(MCA_ED, self).__init__()<br>        <span class="hljs-comment"># enc_list是一个模型列表，包含多个SA(Self-attention)</span><br>        <span class="hljs-comment"># 模块，用于对文本特征进行编码</span><br>        self.enc_list = nn.ModuleList([SA(__C) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(__C.LAYER)])<br>        <span class="hljs-comment"># dec_list是另一个模型列表，包含多个SGA(Self-Guided Attention)</span><br>        <span class="hljs-comment"># 模块，用于对图像特征进行编码</span><br>        self.dec_list = nn.ModuleList([SGA(__C) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(__C.LAYER)])<br><br>    <span class="hljs-comment"># 模型接收四个输入参数：lang（语言特征）、image（图像特征）</span><br>    <span class="hljs-comment"># lang_mask（语言掩码，用于处理变长序列）、image_mask（图像掩码，</span><br>    <span class="hljs-comment"># 用于处理变尺寸的图像）</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, lang, image, lang_mask, image_mask</span>):  <span class="hljs-comment"># lang, image</span><br>        <span class="hljs-comment"># 对输入的语言特征lang进行多层自注意力编码，获得更丰富的语言表示</span><br>        <span class="hljs-keyword">for</span> enc <span class="hljs-keyword">in</span> self.enc_list:<br>            lang = enc(lang, lang_mask)<br>        <br>        <span class="hljs-comment"># 对图像特征image进行多层自注意力解码，并结合编码后的语言特征</span><br>        <span class="hljs-comment"># lang进行自引导注意力操作，最终获得图像特征的融合表示</span><br>        <span class="hljs-keyword">for</span> dec <span class="hljs-keyword">in</span> self.dec_list:<br>            image = dec(image, lang, image_mask, lang_mask)<br><br>        <span class="hljs-keyword">return</span> lang, image<br></code></pre></td></tr></table></figure>

<h4 id="经过mcan处理融合后的图像信息"><a href="#经过mcan处理融合后的图像信息" class="headerlink" title="经过mcan处理融合后的图像信息:"></a>经过mcan处理融合后的图像信息:</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-0.1857</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2427</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.5455</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2758</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.6164</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0748</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-0.7417</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0356</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.2843</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.7573</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.5136</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.6424</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.2079</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.8267</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.0543</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5003</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.3139</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8027</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<h4 id="enhance-text-information"><a href="#enhance-text-information" class="headerlink" title="enhance text information:"></a>enhance text information:</h4><p>根据现有的文本信息和融合后的图像信息，更新state中的文本信息，对文本信息进行加强:</p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716210944396.png" srcset="/img/loading.gif" lazyload alt="image-20230716210944396" style="zoom:80%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">state[<span class="hljs-string">&#x27;encoder_outputs&#x27;</span>] = torch.cat([img_feats, lang_feats], <span class="hljs-number">1</span>)<br><span class="hljs-comment">## 是将两个张量img_feats和lang_feats在维度1上进行拼接</span><br></code></pre></td></tr></table></figure>

<h4 id="拼接-加强-后的文本信息"><a href="#拼接-加强-后的文本信息" class="headerlink" title="拼接(加强)后的文本信息"></a>拼接(加强)后的文本信息</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#x27;encoder_outputs&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-1.8568e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2427e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.5455e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2758e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">6.1642e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0748e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-7.4170e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0356e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.2843e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.7573e+00</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">-5.1359e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.6424e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">2.0789e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8.2671e-01</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.0543e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">5.0033e-01</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">-3.1393e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8027e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>

<p>至此，encode的过程已经结束，encode的输入为预处理后的图像信息以及映射到整数后的文本信息，输出为融合后的图像信息以及融合后的文本信息</p>
<p>其中，对应论文中Joint Reasoning Module的部分，代码实现在mcan.py的部分，在这个文件中，实现了共同注意力的12个self-attention和6个guided-attention，共同的注意力机制将文本信息和图像信息完全地融合与对齐。</p>
<p>其中，在SA和SGA的实现中，使用了FFN(前馈神经网络，对MLP进行了封装)，以及MNATtt(mult-head) Attention，这种注意力机制能够使得模型在不同“头”上学习不同的注意力模式。</p>
<p><strong><code>state[&#39;encoder_outputs&#39;]</code>作为decoder的输入，被输入到一个LSTM decoder中进行解码，decoder利用state,lang_feats,img_feats,img_mask进行初始化，然后将初始化后的state输入LSTM单元中进行解码</strong></p>
<h2 id="decode的过程"><a href="#decode的过程" class="headerlink" title="decode的过程"></a>decode的过程</h2><p><img src="/images/7.16-code-analysis-about-geoqa/image-20230716142750087.png" srcset="/img/loading.gif" lazyload alt="image-20230716142750087"></p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716142840615.png" srcset="/img/loading.gif" lazyload alt="image-20230716142840615" />

<h4 id="首先，初始化decoder的状态"><a href="#首先，初始化decoder的状态" class="headerlink" title="首先，初始化decoder的状态:"></a>首先，初始化decoder的状态:</h4><p>在初始化decoder的过程中，<code>final_lang_feat = util.get_final_encoder_states(                         lang_feats,                         state[&quot;source_mask&quot;],                         self._encoder.is_bidirectional())</code>获取了文本的最后一个特征，然后将其与图像信息进行拼接，实现如下部分:</p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716213334664.png" srcset="/img/loading.gif" lazyload alt="image-20230716213334664" style="zoom:80%;" />

<p><img src="/images/7.16-code-analysis-about-geoqa/image-20230716213354244.png" srcset="/img/loading.gif" lazyload alt="image-20230716213354244"></p>
<p>拼接: <code> feat = torch.cat([final_lang_feat, img_feat], 1)</code></p>
<p>而<code>self.attflat_img(img_feats,img_mask)</code>的部分是如下论文部分的实现:</p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716214209397.png" srcset="/img/loading.gif" lazyload alt="image-20230716214209397" style="zoom:80%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">state = self._init_decoder_state(state, lang_feats, img_feats, img_mask)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_decoder_state</span>(<span class="hljs-params">self, state, lang_feats, img_feats, img_mask</span>):<br>        batch_size = state[<span class="hljs-string">&quot;source_mask&quot;</span>].size(<span class="hljs-number">0</span>)<br>        <span class="hljs-comment"># 得到文本的最后一个特征</span><br>        final_lang_feat = util.get_final_encoder_states(<br>                        lang_feats,<br>                        state[<span class="hljs-string">&quot;source_mask&quot;</span>],<br>                        self._encoder.is_bidirectional())<br>        <span class="hljs-comment"># self.attflat_img = AttFlat(__C)</span><br>        <span class="hljs-comment"># AttFlat类实现了自注意力机制和全连接层的结合，将输入序列中的信息进行加权聚合，得到一个新的表示</span><br>        <span class="hljs-comment"># 在AttFlat类中使用了双层的MLP来处理图像信息</span><br>        img_feat = self.attflat_img(img_feats, img_mask)<br>        feat = torch.cat([final_lang_feat, img_feat], <span class="hljs-number">1</span>)<br>        feat = self.decode_transform(feat)<br>        state[<span class="hljs-string">&quot;concat_feature&quot;</span>] = feat<br><br>        state[<span class="hljs-string">&quot;decoder_hidden&quot;</span>] = feat<br>        <span class="hljs-comment"># C0 shape: (batch_size, decoder_output_dim)</span><br>        state[<span class="hljs-string">&quot;decoder_context&quot;</span>] = torch.zeros(batch_size, self._decoder_output_dim).cuda()<br>        <span class="hljs-comment"># state[&quot;decoder_context&quot;] = state[&quot;encoder_outputs&quot;].new_zeros(batch_size, self._decoder_output_dim)</span><br>        <span class="hljs-keyword">return</span> state<br></code></pre></td></tr></table></figure>

<p>初始化decoder后得到的state:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;source_mask&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> <br> &#x27;concat_mask&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> <br> &#x27;encoder_outputs&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-1.8568e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2427e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.5455e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2758e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">6.1642e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0748e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-7.4170e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0356e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.2843e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.7573e+00</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">-5.1359e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.6424e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">2.0789e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8.2671e-01</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.0543e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">5.0033e-01</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">-3.1393e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8027e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">2.3856e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.3058e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-1.8343e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.0722e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">1.4554e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.7364e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">7.8659e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.6336e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-3.0100e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">9.5237e-01</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">8.1084e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8931e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-6.3895e-03</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.7448e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.7792e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2021e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">6.1907e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.9338e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">-9.9398e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.0618e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.8032e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2120e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">3.6584e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.4790e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-6.0500e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.4447e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.2084e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">6.5523e-01</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">2.2132e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8058e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-4.5138e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.5847e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.3221e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">6.2359e-01</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-number">-6.5195e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0452e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0000e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>        <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">8.2480e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.2435e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.3472e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.4413e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">1.0995e+00</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.7460e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-2.1474e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.5908e+00</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.1710e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">1.6513e+00</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">8.4147e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.5247e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span> <span class="hljs-number">4.5507e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">9.4305e-01</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.9737e+00</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span>  <span class="hljs-number">8.3792e-01</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">4.8650e-01</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0453e+00</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         ...<span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-1.7787e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.4127e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.5389e-02</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-4.0229e-03</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">5.1481e-03</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-4.2730e-03</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-2.3142e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">2.0802e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.3149e-02</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-7.5230e-03</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">8.5205e-04</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-2.3521e-03</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-punctuation">[</span><span class="hljs-number">-1.9417e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.8419e-02</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">1.0621e-02</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-6.4330e-03</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-number">1.5681e-03</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-3.9732e-03</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;CatBackward0&gt;)<span class="hljs-punctuation">,</span> <br><span class="hljs-comment">//论文中的FR，得到的最终encode的文本和图像的结果</span><br>&#x27;concat_feature&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">0.1841</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5670</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0278</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0229</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0041</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1886</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1544</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5350</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0684</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0170</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0535</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1588</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1305</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5631</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0526</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0510</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0656</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1601</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1140</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5501</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0111</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0381</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0347</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1559</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;AddmmBackward0&gt;)<span class="hljs-punctuation">,</span> <br><span class="hljs-comment">//LSTM在t时刻的隐藏状态st</span><br>&#x27;decoder_hidden&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">0.1841</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5670</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0278</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0229</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.0041</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1886</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1544</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5350</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0684</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0170</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0535</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1588</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1305</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5631</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0526</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0510</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0656</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1601</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">0.1140</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">0.5501</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0111</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0381</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0347</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.1559</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;AddmmBackward0&gt;)<span class="hljs-punctuation">,</span> <br>&#x27;decoder_context&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span>  ...<span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="递归解码，使用LSTM单元进行递归解码，生成整个目标序列"><a href="#递归解码，使用LSTM单元进行递归解码，生成整个目标序列" class="headerlink" title="递归解码，使用LSTM单元进行递归解码，生成整个目标序列"></a><strong>递归解码，使用LSTM单元进行递归解码，生成整个目标序列</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">output_dict = self._forward_loop(state, target_tokens)  <span class="hljs-comment"># recurrent decoding for LSTM</span><br></code></pre></td></tr></table></figure>

<p>得到的output_dict:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;predictions&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">15</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">8</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> &#x27;loss&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-number">2.4066</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;DivBackward0&gt;)<span class="hljs-punctuation">&#125;</span> ...<br></code></pre></td></tr></table></figure>

<p>进行知识点的预测，计算知识点的损失函数，并保存在output_dict中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> self.point_ratio != <span class="hljs-number">0</span>:<span class="hljs-comment">#需要考虑知识点</span><br>    concat_feature = state[<span class="hljs-string">&quot;concat_feature&quot;</span>]<br>    <span class="hljs-comment"># 归一化操作</span><br>    point_feat = self.points_norm(concat_feature)<br>    <span class="hljs-comment"># 投影操作</span><br>    point_feat = self.points_proj(point_feat)<br>    <span class="hljs-comment">#  进行 Sigmoid 函数激活，得到一个值范围在 0 到 1 之间的预测概率值 point_pred。这个概率值表示每个知识点的预测置信度</span><br>    point_pred = torch.sigmoid(point_feat)<br>    <span class="hljs-comment"># 计算知识点损失并调节知识点损失在总损失中所占的比例</span><br>    point_loss = self.points_criterion(point_pred, point_label) * self.point_ratio<br>    <span class="hljs-comment"># 存储知识点的预测概率</span><br>    output_dict[<span class="hljs-string">&quot;point_pred&quot;</span>] = point_pred<br>    <span class="hljs-comment"># 存储知识点损失</span><br>    output_dict[<span class="hljs-string">&quot;point_loss&quot;</span>] = point_loss<br>    <span class="hljs-comment"># 将知识点损失加到总体损失中，这样模型在进行训练时，还会优化知识点损失</span><br>    output_dict[<span class="hljs-string">&quot;loss&quot;</span>] += point_loss<br></code></pre></td></tr></table></figure>

<p>计算后的output_dict:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;predictions&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-number">136</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">850</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">599</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1177</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span> <span class="hljs-number">136</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">,</span>  <span class="hljs-number">818</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>       device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;)<span class="hljs-punctuation">,</span> <br> &#x27;loss&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-number">7.8141</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;AddBackward0&gt;)<span class="hljs-punctuation">,</span> <br> &#x27;point_pred&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0.4552</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3563</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3665</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5904</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4875</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7260</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5326</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4646</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5458</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5603</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4952</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4335</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6794</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4520</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5140</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3657</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5173</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6096</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5354</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7347</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4870</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3245</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7726</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6352</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6223</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4108</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4164</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.4443</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5647</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3512</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4421</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6050</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2412</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2990</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3103</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3905</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5547</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5716</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2916</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5286</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5300</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5546</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5452</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5133</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3112</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.3731</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6321</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3663</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4877</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4742</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.5069</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3067</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3451</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5134</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5182</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7757</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4767</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4210</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6802</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.6227</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5106</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4961</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6092</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4707</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4589</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3791</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4650</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5887</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5564</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6933</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4756</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2512</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7658</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6295</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6322</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4123</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4198</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.4111</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4782</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4121</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4020</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5673</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2585</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4545</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2514</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4056</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5961</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5101</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4088</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3904</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5556</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4644</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5947</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5814</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3428</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.3558</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6446</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4494</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6433</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5191</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.4920</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3333</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3406</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5265</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4944</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7473</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4900</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4278</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6322</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.6220</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4848</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4687</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6296</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4290</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4808</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4082</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5069</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5941</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5236</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7076</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4646</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2762</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7472</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6498</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6365</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4332</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4022</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.4381</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5259</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4107</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3769</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6083</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2359</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4039</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2543</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3727</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5819</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5167</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3826</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4297</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5478</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4863</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5893</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5470</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3345</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.3670</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6283</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4061</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6101</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5447</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">[</span><span class="hljs-number">0.4969</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3700</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3529</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5614</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5207</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7504</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5594</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5152</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6049</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5701</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4579</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4550</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6560</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4645</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5446</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3921</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4785</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6119</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5203</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7177</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4605</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3018</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.7567</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6928</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6193</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4212</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4727</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.4148</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4978</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3841</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4249</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5825</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2215</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3627</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2671</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4180</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.5866</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5542</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3559</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.4671</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5564</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5340</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5962</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5357</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3218</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-number">0.3591</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6334</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.3828</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5163</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.5002</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span><br>       grad_fn=&lt;SigmoidBackward0&gt;)<span class="hljs-punctuation">,</span> <br>&#x27;point_loss&#x27;<span class="hljs-punctuation">:</span> tensor(<span class="hljs-number">0.7048</span><span class="hljs-punctuation">,</span> device=&#x27;cuda<span class="hljs-punctuation">:</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> grad_fn=&lt;MulBackward0&gt;)<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="其中，对于point-pred"><a href="#其中，对于point-pred" class="headerlink" title="其中，对于point_pred"></a>其中，对于point_pred</h4><p>point_pred的每一行表示一个样本的预测结果（即一道题的预测结果），例如，对于第一个样本:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[0.4552, 0.3563, 0.3665, 0.5904, 0.4875, 0.7260, 0.5326, 0.4646, 0.5458,</span><br><span class="hljs-string">         0.5603, 0.4952, 0.4335, 0.6794, 0.4520, 0.5140, 0.3657, 0.5173, 0.6096,</span><br><span class="hljs-string">         0.5354, 0.7347, 0.4870, 0.3245, 0.7726, 0.6352, 0.6223, 0.4108, 0.4164,</span><br><span class="hljs-string">         0.4443, 0.5647, 0.3512, 0.4421, 0.6050, 0.2412, 0.2990, 0.3103, 0.3905,</span><br><span class="hljs-string">         0.5547, 0.5716, 0.2916, 0.5286, 0.5300, 0.5546, 0.5452, 0.5133, 0.3112,</span><br><span class="hljs-string">         0.3731, 0.6321, 0.3663, 0.4877, 0.4742]</span>,<br></code></pre></td></tr></table></figure>

<p>对应概率最高的0.7726，对应的index是22，对应的token是‘对应角’</p>
<h4 id="获取执行program"><a href="#获取执行program" class="headerlink" title="获取执行program"></a>获取执行program</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取预测序列  </span><br><span class="hljs-comment"># 从 top_k_predictions 中获取第 b 个样本的第 i 个 Beam（候选预测）。top_k_predictions 是经过 Beam Search 后得到的预测结果</span><br>hypo = <span class="hljs-built_in">list</span>(top_k_predictions[b][i])<br><span class="hljs-comment"># 判断预测序列中是否包含结束符&#x27;end_index&#x27;</span><br><span class="hljs-keyword">if</span> self._end_index <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(hypo):<br>    <span class="hljs-comment"># 保留结束符之前的部分</span><br>    hypo = hypo[:hypo.index(self._end_index)]<br>    <span class="hljs-comment"># 将预测序列中的整数转化成文本  </span><br>    hypo = [self.vocab.get_token_from_index(idx.item()) <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> hypo]<br></code></pre></td></tr></table></figure>

<h4 id="获得的hypo"><a href="#获得的hypo" class="headerlink" title="获得的hypo:"></a>获得的hypo:</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span>&#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;C_3&#x27;<span class="hljs-punctuation">,</span> &#x27;N_0&#x27;<span class="hljs-punctuation">,</span> &#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;V_0&#x27;<span class="hljs-punctuation">,</span> &#x27;N_1&#x27;<span class="hljs-punctuation">,</span> &#x27;g_minus&#x27;<span class="hljs-punctuation">,</span> &#x27;C_3&#x27;<span class="hljs-punctuation">,</span> &#x27;V_1&#x27;<span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<h4 id="执行program"><a href="#执行program" class="headerlink" title="执行program"></a>执行program</h4><p>得到最终答案，并统计正确率和损失率</p>
<p>执行计算:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 执行计算  </span><br>res = self._equ.excuate_equation(hypo, source_nums[b])<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 执行program</span><br>    <span class="hljs-comment"># 例如，exp = [&#x27;N_0&#x27;, &#x27;V_1&#x27;, &#x27;g_divide&#x27;]</span><br>    <span class="hljs-comment"># source_nums = [5, 2]→</span><br>    <span class="hljs-comment"># vars = [2.5]</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">excuate_equation</span>(<span class="hljs-params">self, exp, source_nums=<span class="hljs-literal">None</span></span>):<br><br>        <span class="hljs-keyword">if</span> source_nums <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            source_nums = self.exp_info[<span class="hljs-string">&#x27;nums&#x27;</span>]<br>        <span class="hljs-built_in">vars</span> = []<br>        idx = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> idx &lt; <span class="hljs-built_in">len</span>(exp):<br>            op = exp[idx]<br>            <span class="hljs-comment"># 没有对应的操作符</span><br>            <span class="hljs-keyword">if</span> op <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.op_list:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>            op_nums = self.op_num[op]<br>            <span class="hljs-comment"># 找不到对应的表达式    </span><br>            <span class="hljs-keyword">if</span> idx + op_nums &gt;= <span class="hljs-built_in">len</span>(exp):<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>            excuate_nums = []<br>            <span class="hljs-keyword">for</span> tmp <span class="hljs-keyword">in</span> exp[idx + <span class="hljs-number">1</span>: idx + <span class="hljs-number">1</span> + op_nums]:<br>                <span class="hljs-keyword">if</span> tmp[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;N&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-built_in">len</span>(source_nums):<br>                    excuate_nums.append(source_nums[<span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>])])<br>                <span class="hljs-keyword">elif</span> tmp[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;V&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-built_in">len</span>(<span class="hljs-built_in">vars</span>):<br>                    excuate_nums.append(<span class="hljs-built_in">vars</span>[<span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>])])<br>                <span class="hljs-keyword">elif</span> tmp[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;C&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>]) &lt; <span class="hljs-built_in">len</span>(constant):<br>                    excuate_nums.append(constant[<span class="hljs-built_in">int</span>(tmp[-<span class="hljs-number">1</span>])])<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>            idx += op_nums + <span class="hljs-number">1</span><br>            <span class="hljs-comment"># 执行操作，得到结果</span><br>            v = self.call_op[op](*excuate_nums)<br>            <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>            <span class="hljs-built_in">vars</span>.append(v)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">vars</span><br></code></pre></td></tr></table></figure>

<h2 id="有关辅助任务"><a href="#有关辅助任务" class="headerlink" title="有关辅助任务?"></a>有关辅助任务?</h2><p>knowledge points prediction:</p>
<img src="/images/7.16-code-analysis-about-geoqa/image-20230716231903333.png" srcset="/img/loading.gif" lazyload alt="image-20230716231903333" style="zoom:80%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> self.point_ratio != <span class="hljs-number">0</span>:<span class="hljs-comment">#需要考虑知识点</span><br>        concat_feature = state[<span class="hljs-string">&quot;concat_feature&quot;</span>]<br>        <span class="hljs-comment"># 归一化操作</span><br>        point_feat = self.points_norm(concat_feature)<br>        <span class="hljs-comment"># 投影操作</span><br>        point_feat = self.points_proj(point_feat)<br>        <span class="hljs-comment">#  进行 Sigmoid 函数激活，得到一个值范围在 0 到 1 之间的预测概率值 point_pred。这个概率值表示每个知识点的预测置信度</span><br>        point_pred = torch.sigmoid(point_feat)<br>        <span class="hljs-comment"># 计算知识点损失并调节知识点损失在总损失中所占的比例</span><br>        point_loss = self.points_criterion(point_pred, point_label) * self.point_ratio<br>        <span class="hljs-comment"># 存储知识点的预测概率</span><br>        output_dict[<span class="hljs-string">&quot;point_label&quot;</span>]=point_label<br>        output_dict[<span class="hljs-string">&quot;point_pred&quot;</span>] = point_pred<br>        <span class="hljs-comment"># 存储知识点损失</span><br>        output_dict[<span class="hljs-string">&quot;point_loss&quot;</span>] = point_loss<br>        <span class="hljs-comment"># 将知识点损失加到总体损失中，这样模型在进行训练时，还会优化知识点损失</span><br>        output_dict[<span class="hljs-string">&quot;loss&quot;</span>] += point_loss<br></code></pre></td></tr></table></figure>

<h4 id="其他辅助任务"><a href="#其他辅助任务" class="headerlink" title="其他辅助任务"></a>其他辅助任务</h4><h5 id="jigsaw-location-prediction"><a href="#jigsaw-location-prediction" class="headerlink" title="jigsaw location prediction"></a>jigsaw location prediction</h5><p><img src="/images/7.16-code-analysis-about-geoqa/image-20230716232132074.png" srcset="/img/loading.gif" lazyload alt="image-20230716232132074"></p>
<h5 id="geometry-elements-prediction"><a href="#geometry-elements-prediction" class="headerlink" title="geometry elements prediction"></a>geometry elements prediction</h5><p>?</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%99%BA%E6%85%A7%E6%95%99%E8%82%B2/" class="category-chain-item">智慧教育</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%99%BA%E6%85%A7%E6%95%99%E8%82%B2/">#智慧教育</a>
      
        <a href="/tags/%E8%87%AA%E5%8A%A8%E6%95%B0%E5%AD%A6%E6%B1%82%E8%A7%A3%E5%99%A8/">#自动数学求解器</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>GeoQA代码分析以及论文解读-以题目为例</div>
      <div>http://example.com/2023/07/16/7.16-code-analysis-about-geoqa/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>ECNU_zhy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 16, 2023</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/21/Lexical-Analysis(CC++)-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
